import { API_BASE } from '../config';

export const getPhotoUrl = (venue: any): string | null => {
  // PRIORITY 1: google_photos (local photos - most reliable)
  if (venue.google_photos) {
    try {
      const photos = Array.isArray(venue.google_photos) 
        ? venue.google_photos 
        : JSON.parse(venue.google_photos);
      if (Array.isArray(photos) && photos.length > 0) {
        const photo = photos[0];
        if (photo.startsWith('/')) {
          return API_BASE + photo;
        }
        if (!photo.includes('maps.googleapis.com')) {
          return photo;
        }
      }
    } catch {}
  }
  
  // PRIORITY 2: professional_photos (Instagram)
  if (venue.professional_photos) {
    try {
      const photos = Array.isArray(venue.professional_photos)
        ? venue.professional_photos
        : JSON.parse(venue.professional_photos);
      if (Array.isArray(photos) && photos.length > 0) {
        const url = photos[0]?.url || photos[0];
        if (url && !url.includes('maps.googleapis.com')) {
          return url;
        }
      }
    } catch {}
  }
  
  // PRIORITY 3: Direct URLs (skip Google API URLs)
  if (venue.professional_photo_url && !venue.professional_photo_url.includes('maps.googleapis.com')) {
    return venue.professional_photo_url;
  }
  if (venue.image_url && !venue.image_url.includes('maps.googleapis.com')) {
    return venue.image_url;
  }
  
  return null;
};

export const parseVibeTags = (tags: any): string[] => {
  if (!tags) return [];
  if (Array.isArray(tags)) return tags;
  if (typeof tags === 'string') {
    try {
      const parsed = JSON.parse(tags);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }
  return [];
};
