import React, { useState, useRef, useCallback, useEffect } from 'react';
import {
  View,
  Text,
  StyleSheet,
  Animated,
  TouchableOpacity,
  Dimensions,
  Modal,
  FlatList,
  ActivityIndicator,
  Platform,
  StatusBar,
  Linking,
  Share,
  ScrollView,
  Pressable,
} from 'react-native';
import { useLocalSearchParams, router } from 'expo-router';
import { Image } from 'expo-image';
import { Video, ResizeMode, AVPlaybackStatus } from 'expo-av';
import { BlurView } from 'expo-blur';
import { Ionicons } from '@expo/vector-icons';
import * as Haptics from 'expo-haptics';
import { LinearGradient } from 'expo-linear-gradient';
import AddToPlanSheet from '../../components/AddToPlanSheet';

const { width: SCREEN_WIDTH, height: SCREEN_HEIGHT } = Dimensions.get('window');
const HEADER_MAX_HEIGHT = 350;
const HEADER_MIN_HEIGHT = 100;
const HEADER_SCROLL_DISTANCE = HEADER_MAX_HEIGHT - HEADER_MIN_HEIGHT;

const colors = {
  background: '#0A0A0F',
  card: '#16161F',
  cardBorder: '#2A2A3A',
  accent: '#8B5CF6',
  accentLight: '#A78BFA',
  white: '#FFFFFF',
  textPrimary: '#FFFFFF',
  textSecondary: '#9CA3AF',
  textMuted: '#6B7280',
};

// Category labels for display
const CATEGORY_LABELS: Record<string, string> = {
  restaurant: 'Restaurant',
  lounge: 'Lounge',
  bar: 'Bar',
  cocktail_bar: 'Cocktails',
  rooftop: 'Rooftop',
  club: 'Club',
  night_club: 'Club',
  diner: 'Late Night Eats',
};

interface MediaItem {
  id: string;
  type: 'image' | 'video';
  url: string;
  thumbnail?: string;
  likes?: number;
  comments?: number;
  caption?: string;
}

interface NextStop {
  id: string;
  type: string;
  name: string;
  category: string;
  address?: string;
  neighborhood?: string;
  city?: string;
  rating?: number;
  price_tier?: string;
  vibe_tags?: string[];
  image_url?: string;
  suggested_time?: string;
  time_label?: string;
  reason?: string;
  distance?: string;
  best_tonight?: boolean;
  flow_role?: 'after_dinner' | 'late_night' | 'after_hours';
}

interface EventTonight {
  id: string;
  type: string;
  name: string;
  venue_name?: string;
  venue_id?: string;
  address?: string;
  city?: string;
  time?: string;
  music_genre?: string;
  image_url?: string;
  ticket_url?: string;
  distance?: string;
  reason?: string;
}

interface VenueData {
  id: number;
  name: string;
  neighborhood?: string;
  city?: string;
  address?: string;
  phone?: string;
  website?: string;
  bio?: string;
  category?: string;
  cuisine_primary?: string;
  price_tier?: number;
  price_range?: string;
  rating?: number;
  vibe_tags?: string;
  music_genres?: string;
  energy_level?: string;
  dress_code?: string;
  best_for?: string;
  professional_photo_url?: string;
  google_photos?: string;
  instagram_media?: any[];
  upcoming_events?: any[];
  next_stops?: NextStop[];
  events_tonight?: EventTonight[];
  latitude?: number;
  longitude?: number;
}

export default function VenueDetailScreen() {
  const params = useLocalSearchParams();
  const venueId = params.id as string;

  const scrollY = useRef(new Animated.Value(0)).current;
  const [venue, setVenue] = useState<VenueData | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [showAllPhotos, setShowAllPhotos] = useState(false);
  const [galleryVisible, setGalleryVisible] = useState(false);
  const [galleryIndex, setGalleryIndex] = useState(0);
  const [videoLoading, setVideoLoading] = useState<{ [key: string]: boolean }>({});
  const [showAddToPlanSheet, setShowAddToPlanSheet] = useState(false);
  const [isAddedToFlow, setIsAddedToFlow] = useState(false);
  const [planVenue, setPlanVenue] = useState<any>(null);
  const videoRefs = useRef<{ [key: string]: Video | null }>({});
  const galleryListRef = useRef<FlatList>(null);

  const headerHeight = scrollY.interpolate({
    inputRange: [0, HEADER_SCROLL_DISTANCE],
    outputRange: [HEADER_MAX_HEIGHT, HEADER_MIN_HEIGHT],
    extrapolate: 'clamp',
  });

  const imageOpacity = scrollY.interpolate({
    inputRange: [0, HEADER_SCROLL_DISTANCE / 2, HEADER_SCROLL_DISTANCE],
    outputRange: [1, 0.5, 0],
    extrapolate: 'clamp',
  });

  const imageScale = scrollY.interpolate({
    inputRange: [-100, 0],
    outputRange: [1.5, 1],
    extrapolate: 'clamp',
  });

  useEffect(() => {
    async function fetchVenue() {
      try {
        console.log('Fetching venue', venueId);
        setLoading(true);
        const response = await fetch(`https://lumina.viberyte.com/api/venues/${venueId}`);
        if (!response.ok) throw new Error('Failed to load venue');
        const data = await response.json();
        console.log('Venue loaded:', data.name);
        console.log('Next stops:', data.next_stops?.length || 0);
        console.log('Events tonight:', data.events_tonight?.length || 0);
        setVenue(data);
      } catch (err: any) {
        setError(err.message);
      } finally {
        setLoading(false);
      }
    }
    if (venueId) fetchVenue();
  }, [venueId]);

  const buildMediaArray = useCallback((): MediaItem[] => {
    if (!venue) return [];
    const media: MediaItem[] = [];
    
    if (venue.instagram_media && Array.isArray(venue.instagram_media)) {
      venue.instagram_media.forEach((item: any, idx: number) => {
        const isVideo = item.media_type === 'VIDEO' || 
                       item.media_url?.endsWith('.mp4') ||
                       item.media_url?.endsWith('.mov');
        media.push({
          id: `ig-${item.id || idx}`,
          type: isVideo ? 'video' : 'image',
          url: item.media_url?.startsWith('http') 
            ? item.media_url 
            : `https://lumina.viberyte.com${item.media_url}`,
          thumbnail: item.thumbnail_url?.startsWith('http')
            ? item.thumbnail_url
            : item.thumbnail_url 
              ? `https://lumina.viberyte.com${item.thumbnail_url}`
              : undefined,
          likes: item.likes,
          comments: item.comments,
          caption: item.caption,
        });
      });
    }
    
    if (venue.google_photos) {
      try {
        const photos = typeof venue.google_photos === 'string' 
          ? JSON.parse(venue.google_photos) 
          : venue.google_photos;
        if (Array.isArray(photos)) {
          photos.forEach((url: string, idx: number) => {
            const fullUrl = url.startsWith('http') ? url : `https://lumina.viberyte.com${url}`;
            media.push({
              id: `google-${idx}`,
              type: 'image',
              url: fullUrl,
            });
          });
        }
      } catch (e) {}
    }
    
    return media;
  }, [venue]);

  const allMedia = buildMediaArray();
  const displayedMedia = showAllPhotos ? allMedia : allMedia.slice(0, 20);
  const remainingCount = allMedia.length - 20;

  const openGallery = useCallback((index: number) => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    setGalleryIndex(index);
    setGalleryVisible(true);
  }, []);

  const closeGallery = useCallback(() => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    Object.values(videoRefs.current).forEach(ref => {
      ref?.pauseAsync();
    });
    setGalleryVisible(false);
  }, []);

  const onVideoPlaybackStatusUpdate = useCallback((status: AVPlaybackStatus, itemId: string) => {
    if (status.isLoaded) {
      setVideoLoading(prev => ({ ...prev, [itemId]: false }));
    }
  }, []);

  const parseJSON = (str: string | undefined, fallback: any[] = []) => {
    if (!str) return fallback;
    try {
      return JSON.parse(str);
    } catch {
      return fallback;
    }
  };

  const handleAddToFlow = () => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
    setPlanVenue({
      id: venue?.id,
      name: venue?.name,
      category: venue?.category,
      neighborhood: venue?.neighborhood,
      address: venue?.address,
      photo: allMedia[0]?.url,
      rating: venue?.rating,
      price_range: venue?.price_range,
    });
    setShowAddToPlanSheet(true);
  };

  const handleAddNextStop = (stop: NextStop) => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
    const imageUrl = stop.image_url?.startsWith('http') 
      ? stop.image_url 
      : `https://lumina.viberyte.com${stop.image_url}`;
    setPlanVenue({
      id: Number(stop.id),
      name: stop.name,
      category: stop.category,
      neighborhood: stop.neighborhood,
      address: stop.address,
      photo: imageUrl,
      suggested_time: stop.suggested_time,
    });
    setShowAddToPlanSheet(true);
  };

  const handleAddEvent = (event: EventTonight) => {
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium);
    setPlanVenue({
      id: Number(event.venue_id) || Number(event.id),
      name: event.name,
      category: 'event',
      venue_name: event.venue_name,
      photo: event.image_url,
      time: event.time,
    });
    setShowAddToPlanSheet(true);
  };

  const handlePlanSuccess = (message: string) => {
    setIsAddedToFlow(true);
  };

  const handleShare = async () => {
    if (!venue) return;
    Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
    try {
      await Share.share({
        message: `Check out ${venue.name} on Lumina!\nhttps://lumina.app/venue/${venue.id}`,
      });
    } catch (error) {
      console.error(error);
    }
  };

  if (loading) {
    return (
      <View style={[styles.container, styles.centered]}>
        <ActivityIndicator size="large" color={colors.accent} />
        <Text style={styles.loadingText}>Loading venue...</Text>
      </View>
    );
  }

  if (error || !venue) {
    return (
      <View style={[styles.container, styles.centered]}>
        <Ionicons name="alert-circle" size={48} color={colors.textMuted} />
        <Text style={styles.errorText}>{error || 'Venue not found'}</Text>
        <TouchableOpacity style={styles.retryButton} onPress={() => router.back()}>
          <Text style={styles.retryText}>Go Back</Text>
        </TouchableOpacity>
      </View>
    );
  }

  const heroImage = venue.professional_photo_url || allMedia[0]?.url;
  const vibeTags = parseJSON(venue.vibe_tags);
  const musicGenres = parseJSON(venue.music_genres);

  const renderGridItem = ({ item, index }: { item: MediaItem; index: number }) => (
    <TouchableOpacity 
      style={styles.gridItem}
      onPress={() => openGallery(index)}
      activeOpacity={0.8}
    >
      <Image
        source={{ uri: item.thumbnail || item.url }}
        style={styles.gridImage}
        contentFit="cover"
        cachePolicy="memory-disk"
        transition={200}
      />
      {item.type === 'video' && (
        <View style={styles.videoIndicator}>
          <Ionicons name="play-circle" size={28} color="white" />
        </View>
      )}
    </TouchableOpacity>
  );

  const renderGalleryItem = ({ item, index }: { item: MediaItem; index: number }) => {
    const isCurrentItem = index === galleryIndex;
    
    if (item.type === 'video') {
      return (
        <View style={styles.gallerySlide}>
          {videoLoading[item.id] !== false && (
            <View style={styles.videoLoadingOverlay}>
              <ActivityIndicator size="large" color={colors.accent} />
            </View>
          )}
          <Video
            ref={(ref) => { videoRefs.current[item.id] = ref; }}
            source={{ uri: item.url }}
            style={styles.galleryVideo}
            resizeMode={ResizeMode.CONTAIN}
            shouldPlay={isCurrentItem && galleryVisible}
            isLooping
            useNativeControls
            onPlaybackStatusUpdate={(status) => onVideoPlaybackStatusUpdate(status, item.id)}
            onLoadStart={() => setVideoLoading(prev => ({ ...prev, [item.id]: true }))}
          />
        </View>
      );
    }

    return (
      <View style={styles.gallerySlide}>
        <Image
          source={{ uri: item.url }}
          style={styles.galleryImage}
          contentFit="contain"
          cachePolicy="memory-disk"
          transition={200}
        />
      </View>
    );
  };

  const onGalleryScroll = useCallback((event: any) => {
    const newIndex = Math.round(event.nativeEvent.contentOffset.x / SCREEN_WIDTH);
    if (newIndex !== galleryIndex && newIndex >= 0 && newIndex < allMedia.length) {
      const prevItem = allMedia[galleryIndex];
      if (prevItem?.type === 'video' && videoRefs.current[prevItem.id]) {
        videoRefs.current[prevItem.id]?.pauseAsync();
      }
      setGalleryIndex(newIndex);
      const newItem = allMedia[newIndex];
      if (newItem?.type === 'video' && videoRefs.current[newItem.id]) {
        videoRefs.current[newItem.id]?.playAsync();
      }
    }
  }, [galleryIndex, allMedia]);

  return (
    <View style={styles.container}>
      <StatusBar barStyle="light-content" />
      
      <Animated.View style={[styles.header, { height: headerHeight }]}>
        {heroImage && (
          <Animated.View style={{ opacity: imageOpacity, transform: [{ scale: imageScale }], flex: 1 }}>
            <Image
              source={{ uri: heroImage }}
              style={styles.heroImage}
              contentFit="cover"
              cachePolicy="memory-disk"
            />
          </Animated.View>
        )}
        <LinearGradient
          colors={['transparent', 'rgba(10,10,15,0.8)', colors.background]}
          style={styles.heroGradient}
        />
      </Animated.View>

      <View style={styles.topBar}>
        <TouchableOpacity 
          style={styles.backButton} 
          onPress={() => {
            Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light);
            router.back();
          }}
        >
          <BlurView intensity={30} tint="dark" style={styles.blurButton}>
            <Ionicons name="arrow-back" size={22} color="white" />
          </BlurView>
        </TouchableOpacity>
        
        <TouchableOpacity style={styles.shareButton} onPress={handleShare}>
          <BlurView intensity={30} tint="dark" style={styles.blurButton}>
            <Ionicons name="share-outline" size={22} color="white" />
          </BlurView>
        </TouchableOpacity>
      </View>

      <Animated.ScrollView
        showsVerticalScrollIndicator={false}
        scrollEventThrottle={16}
        onScroll={Animated.event(
          [{ nativeEvent: { contentOffset: { y: scrollY } } }],
          { useNativeDriver: false }
        )}
      >
        <View style={{ height: HEADER_MAX_HEIGHT - 60 }} />
        
        <View style={styles.content}>
          <Text style={styles.venueName}>{venue.name}</Text>
          
          <View style={styles.metaRow}>
            {venue.neighborhood && <Text style={styles.metaText}>{venue.neighborhood}</Text>}
            {venue.city && (
              <>
                <Text style={styles.metaDot}>â€¢</Text>
                <Text style={styles.metaText}>{venue.city}</Text>
              </>
            )}
            {venue.price_tier && (
              <>
                <Text style={styles.metaDot}>â€¢</Text>
                <Text style={styles.metaText}>{'$'.repeat(venue.price_tier)}</Text>
              </>
            )}
          </View>

          {allMedia.length > 0 && (
            <View style={styles.section}>
              <View style={styles.sectionHeader}>
                <Text style={styles.sectionTitle}>Photos & Videos</Text>
                <Text style={styles.sectionCount}>{allMedia.length}</Text>
              </View>
              
              <FlatList
                data={displayedMedia}
                renderItem={renderGridItem}
                keyExtractor={(item) => item.id}
                numColumns={3}
                scrollEnabled={false}
                columnWrapperStyle={styles.gridRow}
              />
              
              {!showAllPhotos && remainingCount > 0 && (
                <TouchableOpacity 
                  style={styles.seeMoreButton}
                  onPress={() => setShowAllPhotos(true)}
                >
                  <Text style={styles.seeMoreText}>See All {remainingCount} More</Text>
                  <Ionicons name="chevron-down" size={18} color={colors.accent} />
                </TouchableOpacity>
              )}
            </View>
          )}

          {venue.bio && (
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>About</Text>
              <Text style={styles.bioText}>{venue.bio}</Text>
            </View>
          )}

          {vibeTags.length > 0 && (
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Vibe</Text>
              <View style={styles.tagsContainer}>
                {vibeTags.map((tag: string, idx: number) => (
                  <View key={idx} style={styles.tag}>
                    <Text style={styles.tagText}>{tag}</Text>
                  </View>
                ))}
              </View>
            </View>
          )}

          {musicGenres.length > 0 && (
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>Music</Text>
              <View style={styles.tagsContainer}>
                {musicGenres.map((genre: string, idx: number) => (
                  <View key={idx} style={styles.musicTag}>
                    <Ionicons name="musical-notes" size={12} color={colors.accent} />
                    <Text style={styles.musicTagText}>{genre}</Text>
                  </View>
                ))}
              </View>
            </View>
          )}

          {/* ============ NEXT STOPS SECTION ============ */}
          {venue.next_stops && venue.next_stops.length > 0 && (
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>
                {venue.next_stops[0]?.time_label || 'Next Stop'}
              </Text>
              {venue.next_stops.length > 2 && (
                <Text style={styles.swipeHint}>Swipe to see more</Text>
              )}
              
              <ScrollView horizontal showsHorizontalScrollIndicator={false}>
                {venue.next_stops.map((stop) => (
                  <Pressable
                    key={stop.id}
                    onPress={() => router.push(`/venue/${stop.id}`)}
                    style={({ pressed }) => [
                      styles.nextStopCard,
                      { opacity: pressed ? 0.92 : 1 }
                    ]}
                  >
                    <Image
                      source={{ 
                        uri: stop.image_url?.startsWith('http') 
                          ? stop.image_url 
                          : `https://lumina.viberyte.com${stop.image_url}` 
                      }}
                      style={styles.nextStopImage}
                      contentFit="cover"
                    />
                    
                    {stop.best_tonight && (
                      <View style={styles.hotBadge}>
                        <Text style={styles.hotBadgeText}>ðŸ”¥ HOT TONIGHT</Text>
                      </View>
                    )}
                    
                    <View style={styles.nextStopContent}>
                      <Text style={styles.nextStopName} numberOfLines={1}>
                        {stop.name}
                      </Text>
                      
                      <Text style={styles.nextStopMeta}>
                        {CATEGORY_LABELS[stop.category] || stop.category}
                        {stop.distance ? ` Â· ${stop.distance}` : ''}
                      </Text>
                      
                      {stop.reason && (
                        <Text style={styles.nextStopReason}>
                          {stop.reason}
                        </Text>
                      )}
                      
                      <TouchableOpacity
                        onPress={(e) => {
                          e.stopPropagation();
                          handleAddNextStop(stop);
                        }}
                        style={styles.addToPlanButton}
                        activeOpacity={0.85}
                      >
                        <Text style={styles.addToPlanText}>Add to Plan</Text>
                      </TouchableOpacity>
                    </View>
                  </Pressable>
                ))}
              </ScrollView>
            </View>
          )}

          {/* ============ EVENTS TONIGHT SECTION ============ */}
          {venue.events_tonight && venue.events_tonight.length > 0 && (
            <View style={styles.section}>
              <Text style={styles.sectionTitle}>ðŸŽ‰ Happening Tonight</Text>
              
              {venue.events_tonight.map((event) => (
                <Pressable
                  key={event.id}
                  onPress={() => event.venue_id && router.push(`/venue/${event.venue_id}`)}
                  style={({ pressed }) => [
                    styles.eventCard,
                    { opacity: pressed ? 0.92 : 1 }
                  ]}
                >
                  {event.image_url && (
                    <Image
                      source={{ uri: event.image_url }}
                      style={styles.eventImage}
                      contentFit="cover"
                    />
                  )}
                  
                  <View style={styles.eventContent}>
                    <Text style={styles.eventName} numberOfLines={1}>
                      {event.name}
                    </Text>
                    
                    {event.venue_name && (
                      <Text style={styles.eventVenue}>@ {event.venue_name}</Text>
                    )}
                    
                    <View style={styles.eventMeta}>
                      {event.time && (
                        <Text style={styles.eventTime}>{event.time}</Text>
                      )}
                      {event.distance && (
                        <Text style={styles.eventDistance}>Â· {event.distance}</Text>
                      )}
                    </View>
                  </View>
                  
                  <TouchableOpacity
                    onPress={(e) => {
                      e.stopPropagation();
                      handleAddEvent(event);
                    }}
                    style={styles.eventAddButton}
                    activeOpacity={0.85}
                  >
                    <Text style={styles.eventAddText}>Add</Text>
                  </TouchableOpacity>
                </Pressable>
              ))}
            </View>
          )}

          <View style={styles.section}>
            {venue.address && (
              <TouchableOpacity 
                style={styles.contactRow}
                onPress={() => Linking.openURL(`https://maps.google.com/?q=${encodeURIComponent(venue.address!)}`)}
              >
                <Ionicons name="location" size={20} color={colors.accent} />
                <Text style={styles.contactText}>{venue.address}</Text>
                <Ionicons name="chevron-forward" size={18} color={colors.textMuted} />
              </TouchableOpacity>
            )}
            {venue.phone && (
              <TouchableOpacity 
                style={styles.contactRow}
                onPress={() => Linking.openURL(`tel:${venue.phone}`)}
              >
                <Ionicons name="call" size={20} color={colors.accent} />
                <Text style={styles.contactText}>{venue.phone}</Text>
                <Ionicons name="chevron-forward" size={18} color={colors.textMuted} />
              </TouchableOpacity>
            )}
            {venue.website && (
              <TouchableOpacity 
                style={styles.contactRow}
                onPress={() => Linking.openURL(venue.website!)}
              >
                <Ionicons name="globe" size={20} color={colors.accent} />
                <Text style={styles.contactText}>Visit Website</Text>
                <Ionicons name="chevron-forward" size={18} color={colors.textMuted} />
              </TouchableOpacity>
            )}
          </View>

          <View style={{ height: 120 }} />
        </View>
      </Animated.ScrollView>

      {/* Sticky CTA */}
      <View style={styles.stickyCtaContainer}>
        <LinearGradient colors={['transparent', colors.background]} style={styles.ctaGradient} />
        <TouchableOpacity style={styles.ctaButton} onPress={handleAddToFlow}>
          <LinearGradient
            colors={isAddedToFlow ? ['#4CAF50', '#45A049'] : [colors.accent, '#7C3AED']}
            start={{ x: 0, y: 0 }}
            end={{ x: 1, y: 0 }}
            style={styles.ctaGradientButton}
          >
            <Ionicons name={isAddedToFlow ? "checkmark-circle" : "add-circle"} size={22} color="white" />
            <Text style={styles.ctaText}>{isAddedToFlow ? "Added to Plans" : "Add to Plans"}</Text>
          </LinearGradient>
        </TouchableOpacity>
      </View>

      {/* Gallery Modal */}
      <Modal visible={galleryVisible} transparent animationType="fade" onRequestClose={closeGallery}>
        <View style={styles.galleryContainer}>
          <View style={styles.galleryHeader}>
            <TouchableOpacity onPress={closeGallery} style={styles.galleryCloseButton}>
              <Ionicons name="close" size={28} color="white" />
            </TouchableOpacity>
            <Text style={styles.galleryCounter}>{galleryIndex + 1} / {allMedia.length}</Text>
            <View style={{ width: 28 }} />
          </View>
          <FlatList
            ref={galleryListRef}
            data={allMedia}
            renderItem={renderGalleryItem}
            keyExtractor={(item) => item.id}
            horizontal
            pagingEnabled
            showsHorizontalScrollIndicator={false}
            initialScrollIndex={galleryIndex}
            getItemLayout={(_, index) => ({ length: SCREEN_WIDTH, offset: SCREEN_WIDTH * index, index })}
            onMomentumScrollEnd={onGalleryScroll}
          />
        </View>
      </Modal>

      {/* Add to Plan Sheet */}
      <AddToPlanSheet
        visible={showAddToPlanSheet}
        venue={planVenue}
        onClose={() => setShowAddToPlanSheet(false)}
        onSuccess={handlePlanSuccess}
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: colors.background },
  centered: { justifyContent: 'center', alignItems: 'center' },
  loadingText: { marginTop: 16, color: colors.textSecondary, fontSize: 16 },
  errorText: { marginTop: 16, color: colors.textSecondary, fontSize: 16 },
  retryButton: { marginTop: 24, paddingHorizontal: 24, paddingVertical: 12, backgroundColor: colors.accent, borderRadius: 8 },
  retryText: { color: 'white', fontWeight: '600' },
  header: { position: 'absolute', top: 0, left: 0, right: 0, overflow: 'hidden', zIndex: 10 },
  heroImage: { width: '100%', height: '100%' },
  heroGradient: { position: 'absolute', bottom: 0, left: 0, right: 0, height: 150 },
  topBar: { position: 'absolute', top: Platform.OS === 'ios' ? 50 : 30, left: 0, right: 0, flexDirection: 'row', justifyContent: 'space-between', paddingHorizontal: 16, zIndex: 20 },
  backButton: { width: 40, height: 40 },
  shareButton: { width: 40, height: 40 },
  blurButton: { width: 40, height: 40, borderRadius: 20, overflow: 'hidden', justifyContent: 'center', alignItems: 'center' },
  content: { backgroundColor: colors.background, borderTopLeftRadius: 24, borderTopRightRadius: 24, marginTop: -24, paddingHorizontal: 20, paddingTop: 24 },
  venueName: { fontSize: 28, fontWeight: '700', color: colors.textPrimary, marginBottom: 8 },
  metaRow: { flexDirection: 'row', alignItems: 'center', marginBottom: 24 },
  metaText: { fontSize: 15, color: colors.textSecondary },
  metaDot: { fontSize: 15, color: colors.textMuted, marginHorizontal: 8 },
  section: { marginBottom: 28 },
  sectionHeader: { flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 },
  sectionTitle: { fontSize: 18, fontWeight: '600', color: colors.textPrimary, marginBottom: 12 },
  sectionCount: { fontSize: 14, color: colors.textMuted, marginBottom: 12 },
  swipeHint: { color: '#666', fontSize: 12, marginBottom: 8, marginTop: -8 },
  gridRow: { justifyContent: 'space-between', marginBottom: 4 },
  gridItem: { width: (SCREEN_WIDTH - 48) / 3, height: (SCREEN_WIDTH - 48) / 3, borderRadius: 8, overflow: 'hidden', marginBottom: 4 },
  gridImage: { width: '100%', height: '100%' },
  videoIndicator: { position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, justifyContent: 'center', alignItems: 'center', backgroundColor: 'rgba(0,0,0,0.3)' },
  seeMoreButton: { flexDirection: 'row', alignItems: 'center', justifyContent: 'center', paddingVertical: 16, marginTop: 8, backgroundColor: colors.card, borderRadius: 12, borderWidth: 1, borderColor: colors.cardBorder },
  seeMoreText: { color: colors.accent, fontSize: 15, fontWeight: '600', marginRight: 6 },
  bioText: { fontSize: 15, color: colors.textSecondary, lineHeight: 24 },
  tagsContainer: { flexDirection: 'row', flexWrap: 'wrap', marginTop: 4 },
  tag: { backgroundColor: colors.card, paddingHorizontal: 14, paddingVertical: 8, borderRadius: 20, marginRight: 8, marginBottom: 8, borderWidth: 1, borderColor: colors.cardBorder },
  tagText: { color: colors.textSecondary, fontSize: 13 },
  musicTag: { flexDirection: 'row', alignItems: 'center', backgroundColor: 'rgba(139, 92, 246, 0.1)', paddingHorizontal: 12, paddingVertical: 8, borderRadius: 20, marginRight: 8, marginBottom: 8 },
  musicTagText: { color: colors.accent, fontSize: 13, marginLeft: 6 },
  contactRow: { flexDirection: 'row', alignItems: 'center', paddingVertical: 16, borderBottomWidth: 1, borderBottomColor: colors.cardBorder },
  contactText: { flex: 1, fontSize: 15, color: colors.textSecondary, marginLeft: 14 },
  
  // Next Stops Styles
  nextStopCard: { width: 200, marginRight: 12, backgroundColor: '#1a1a1a', borderRadius: 12, borderWidth: 1, borderColor: '#2a2a2a', overflow: 'hidden' },
  nextStopImage: { width: '100%', height: 120 },
  hotBadge: { position: 'absolute', top: 8, left: 8, backgroundColor: '#EF4444', paddingHorizontal: 8, paddingVertical: 4, borderRadius: 6 },
  hotBadgeText: { color: '#fff', fontSize: 10, fontWeight: '700' },
  nextStopContent: { padding: 12 },
  nextStopName: { color: '#fff', fontSize: 14, fontWeight: '600' },
  nextStopMeta: { color: '#888', fontSize: 12, marginTop: 2 },
  nextStopReason: { color: colors.accent, fontSize: 12, marginTop: 6 },
  addToPlanButton: { marginTop: 10, backgroundColor: colors.accent, paddingVertical: 8, borderRadius: 8, alignItems: 'center' },
  addToPlanText: { color: '#fff', fontSize: 12, fontWeight: '600' },
  
  // Events Tonight Styles
  eventCard: { flexDirection: 'row', backgroundColor: '#1a1a1a', borderRadius: 12, borderWidth: 1, borderColor: '#2a2a2a', marginBottom: 10, overflow: 'hidden' },
  eventImage: { width: 80, height: 80 },
  eventContent: { flex: 1, padding: 12, justifyContent: 'center' },
  eventName: { color: '#fff', fontSize: 14, fontWeight: '600' },
  eventVenue: { color: '#888', fontSize: 12, marginTop: 2 },
  eventMeta: { flexDirection: 'row', alignItems: 'center', marginTop: 4 },
  eventTime: { color: colors.accent, fontSize: 12 },
  eventDistance: { color: '#666', fontSize: 12, marginLeft: 4 },
  eventAddButton: { backgroundColor: colors.accent, paddingHorizontal: 16, justifyContent: 'center', alignItems: 'center' },
  eventAddText: { color: '#fff', fontSize: 12, fontWeight: '600' },
  
  // Sticky CTA
  stickyCtaContainer: { position: 'absolute', bottom: 0, left: 0, right: 0, paddingBottom: Platform.OS === 'ios' ? 34 : 20, paddingHorizontal: 20, paddingTop: 20, zIndex: 50 },
  ctaGradient: { position: 'absolute', top: -40, left: 0, right: 0, height: 40 },
  ctaButton: { borderRadius: 16, overflow: 'hidden' },
  ctaGradientButton: { flexDirection: 'row', alignItems: 'center', justifyContent: 'center', paddingVertical: 18 },
  ctaText: { color: 'white', fontSize: 17, fontWeight: '700', marginLeft: 10 },
  
  // Gallery
  galleryContainer: { flex: 1, backgroundColor: 'black' },
  galleryHeader: { position: 'absolute', top: 0, left: 0, right: 0, zIndex: 10, flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', paddingTop: Platform.OS === 'ios' ? 60 : 40, paddingHorizontal: 16, paddingBottom: 16 },
  galleryCloseButton: { padding: 8 },
  galleryCounter: { color: 'white', fontSize: 16, fontWeight: '500' },
  gallerySlide: { width: SCREEN_WIDTH, height: SCREEN_HEIGHT, justifyContent: 'center', alignItems: 'center' },
  galleryImage: { width: SCREEN_WIDTH, height: SCREEN_HEIGHT * 0.7 },
  galleryVideo: { width: SCREEN_WIDTH, height: SCREEN_HEIGHT * 0.7, backgroundColor: 'black' },
  videoLoadingOverlay: { position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, justifyContent: 'center', alignItems: 'center', zIndex: 5 },
});
